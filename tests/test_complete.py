from binascii import a2b_hex

import pytest

from smllib.reader import SmlStreamReader


@pytest.mark.parametrize(
    'frame', (
        pytest.param(
            b'1b1b1b1b0101010176051c414c02620062007263010176010102310b0a01445a47000282c0b07262016505471c2a620263f9380'
            b'076051d414c02620062007263070177010b0a01445a47000282c0b0070100620affff7262016505471c2a747707010060320101'
            b'0172620162006200520004445a470177070100600100ff017262016200620052000b0a01445a47000282c0b0017707010001080'
            b'0ff641c01047262016200621e520363344f0177070100020800ff017262016200621e520362000101016393770076051e414c02'
            b'6200620072630201710163e6ba00000000001b1b1b1b1a04dad0',
            id='Frame1'
        ),
        pytest.param(
            b'1b1b1b1b0101010176040000016200620072650000010176010107000002dba23c0b0a01484c5902000424a0010163945b00760'
            b'40000026200620072650000070177010b0a01484c5902000424a00101f10477070100603201010101010104484c590177070100'
            b'600100ff010101010b0a01484c5902000424a00177070100010800ff65001c81046502dba23d621e52ff6502aea132017707010'
            b'0020800ff65001c81046502dba23d621e52ff62000177070100100700ff0101621b52005300890177070100200700ff01016223'
            b'52ff6309280177070100340700ff0101622352ff6309290177070100480700ff0101622352ff63092201770701001f0700ff010'
            b'1622152fe62290177070100330700ff0101622152fe624e0177070100470700ff0101622152fe622e0177070100510701ff0101'
            b'6208520062f00177070100510702ff01016208520062780177070100510704ff010162085200630110017707010051070fff010'
            b'162085200630138017707010051071aff01016208520063011101770701000e0700ff0101622c52ff6301f40177070100000200'
            b'000101010109312e30322e3030370177070100605a02010101010105413031410177070100600500ff0101010165001c8104010'
            b'10163fc1e00760400000362006200726500000201710163e8230000001b1b1b1b1a0222ed',
            id='Frame2'
        ),
    )
)
def test_frames(frame):

    reader = SmlStreamReader()
    reader.add(a2b_hex(frame))

    frame = reader.get_frame()
    assert frame is not None

    sml_messages = frame.parse_frame()
    assert len(sml_messages) >= 3, sml_messages

    obis_values = frame.get_obis()
    assert len(obis_values) >= 4, obis_values

    for obis in obis_values:
        obis.get_value()
